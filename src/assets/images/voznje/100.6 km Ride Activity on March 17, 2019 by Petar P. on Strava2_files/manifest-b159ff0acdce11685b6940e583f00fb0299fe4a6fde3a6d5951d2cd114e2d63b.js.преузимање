(function(){Strava.module("Strava.D3.Charts"),Strava.D3.Charts.Util={autoDomain:function(t,e){var r,a,i,n,s,o,h,c,p,l;return null==e&&(e={}),_.defaults(e,{paddingBottom:0,paddingTop:0,innerClamp:0}),a=d3.extent(t),n=a[0],i=a[1],o=i-n,e.outerClamp||(e.outerClamp=d3.max([e.innerClamp,o])),r=100-(e.paddingBottom+e.paddingTop),e.innerRange||(e.innerRange=r),l=d3.scale.linear().domain([e.innerClamp,e.outerClamp]).range([e.innerRange,r]).clamp(!0),s=l(o),h=e.paddingBottom+r/2,p=[h-s/2,h+s/2],c=d3.scale.linear().domain(a).range(p),[c.invert(0),c.invert(100)]},closestOrdinalValue:function(t,e){var r,a,i,n,s,o,h;for(o=e.range(),a=i=0,n=o.length;n>i;a=++i)if(h=o[a],h>t||a===o.length-1?r=a:(s=o[a+1],s>t&&(r=s-t>t-h?a:a+1)),"number"==typeof r)return e.domain()[r]},getPathPositionAt:function(t,e){var r,a,i,n;for(i=e,r=t.getTotalLength(),n=null;;){if(n=Math.floor((i+r)/2),a=t.getPointAtLength(n),(n===r||n===i)&&a.x!==e)break;if(a.x>e)r=n;else{if(!(a.x<e))break;i=n}}return a},niceTimeTicks:function(t,e){var r,a,i;return i=t.map(function(t){return new Date(d3.round(1e3*t))}),r=d3.time.scale().domain(i),a=r.ticks(e),a.map(function(t){return t.getTime()/1e3})}}}).call(this),function(){Strava.module("Strava.Directory"),Strava.Directory.ElevationDataContext=function(){function t(t,e,r){this.streams=t,this.rabbit=e,this.eventDispatcher=r}return t.prototype.distanceStream=function(){return this.convertedDistanceStream||(this.convertedDistanceStream=this.convertDistanceStream())},t.prototype.elevationStream=function(){return this.convertedElevationStream||(this.convertedElevationStream=this.convertElevationStream())},t.prototype.latlngStream=function(){return this.streams.latlng},t.prototype.convertDistanceStream=function(){var t;return this.streams.isConverted?this.streams.distance:(t=new Strava.I18n.DistanceFormatter,this.streams.distance.map(function(e){return t.convert(e)}))},t.prototype.convertElevationStream=function(){var t;return this.streams.isConverted?this.streams.altitude:(t=new Strava.I18n.ElevationFormatter,this.streams.altitude.map(function(e){return t.convert(e)}))},t.prototype.gradeAtIndex=function(t){var e,r,a,i,n,s,o,h;return e=this.streams.distance,i=this.streams.altitude,o=e.length-1,h=2,h>t&&(t=h),h>o-t&&(t=o-h),r=e[t+h]-e[t-h],n=i[t+h]-i[t-h],this.streams.isConverted&&(a=new Strava.I18n.DistanceFormatter,s=new Strava.I18n.ElevationFormatter,r/=a.convert(1),n/=s.convert(1)),100*n/r},t}()}.call(this),function(){var t=function(t,r){function a(){this.constructor=t}for(var i in r)e.call(r,i)&&(t[i]=r[i]);return a.prototype=r.prototype,t.prototype=new a,t.__super__=r.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.Directory"),Strava.Directory.ElevationChart=function(e){function r(){return r.__super__.constructor.apply(this,arguments)}return t(r,e),r.prototype.CONTAINER={HEIGHT:250,WIDTH:783,MARGINS:{TOP:20,RIGHT:0,BOTTOM:30,LEFT:50}},r.prototype.INFO_BOX={WIDTH:120,HEIGHT:60,LINE_HEIGHT:16,PADDING:{TOP:4,LEFT:10},MARGIN:{SIDE:12,TOP:6}},r.prototype.el="#elev-chart",r.prototype.initialize=function(t){return this.dataContext=t,this.distanceStream=this.dataContext.distanceStream(),this.elevationStream=this.dataContext.elevationStream(),this.latlngStream=this.dataContext.latlngStream(),this.rabbit=this.dataContext.rabbit,this.eventDispatcher=this.dataContext.eventDispatcher},r.prototype.render=function(){return this.width=this.getContainerWidth()-this.CONTAINER.MARGINS.LEFT-this.CONTAINER.MARGINS.RIGHT,this.height=this.CONTAINER.HEIGHT-this.CONTAINER.MARGINS.BOTTOM-this.CONTAINER.MARGINS.TOP,this.xScale=this.createXScale(),this.yScale=this.createYScale(),this.svg=d3.select("#elev-chart").append("svg").attr("width",this.getContainerWidth()).attr("height",this.CONTAINER.HEIGHT).append("g").attr("transform","translate("+this.CONTAINER.MARGINS.LEFT+", "+this.CONTAINER.MARGINS.TOP+")"),this.distanceFormatter=new Strava.I18n.ChartLabelDistanceFormatter,this.elevationFormatter=new Strava.I18n.ChartLabelElevationFormatter,this.gradeFormatter=new Strava.I18n.PercentFormatter,this.drawXAxis(),this.drawYAxis(),this.styleTicks(),this.drawLine(),this.infoBox=this.createInfoBox(),this.hoverLine=this.createHoverLine(),this.createHoverTarget(),this},r.prototype.getContainerWidth=function(){return this.$el.width()||this.CONTAINER.WIDTH},r.prototype.createXScale=function(){return d3.scale.linear().range([0,this.width]).domain(this.xDomain(this.distanceStream))},r.prototype.xDomain=function(t){return[t[0],t[t.length-1]]},r.prototype.createYScale=function(){return d3.scale.linear().range([this.height,0]).domain(this.yDomain(this.elevationStream))},r.prototype.yDomain=function(t){var e,r,a;return a=d3.extent(t),r=a[0],e=a[1],Strava.D3.Charts.Util.autoDomain(t,{paddingBottom:10,paddingTop:10})},r.prototype.createInfoBox=function(){var t,e,r,a;return a=this.svg.append("g").style("display","none"),a.append("rect").attr({"class":"info-box",id:"segment-info-box",y:this.INFO_BOX.MARGIN.TOP,width:this.INFO_BOX.WIDTH,height:this.INFO_BOX.HEIGHT}),t=a.append("text").attr({x:this.INFO_BOX.PADDING.LEFT,y:this.INFO_BOX.MARGIN.TOP+this.INFO_BOX.PADDING.TOP+this.INFO_BOX.LINE_HEIGHT}),t.append("tspan").text(Strava.I18n.Locale.t("strava.segments.elevation_chart.distance")),t.append("tspan").attr({id:"segment-info-box-distance","class":"info-box-value"}),e=a.append("text").attr({x:this.INFO_BOX.PADDING.LEFT,y:this.INFO_BOX.MARGIN.TOP+this.INFO_BOX.PADDING.TOP+2*this.INFO_BOX.LINE_HEIGHT}),e.append("tspan").text(Strava.I18n.Locale.t("strava.segments.elevation_chart.elevation")),e.append("tspan").attr({id:"segment-info-box-elevation","class":"info-box-value"}),r=a.append("text").attr({x:this.INFO_BOX.PADDING.LEFT,y:this.INFO_BOX.MARGIN.TOP+this.INFO_BOX.PADDING.TOP+3*this.INFO_BOX.LINE_HEIGHT}),r.append("tspan").text(Strava.I18n.Locale.t("strava.segments.elevation_chart.grade")),r.append("tspan").attr({id:"segment-info-box-grade","class":"info-box-value"}),a},r.prototype.createHoverLine=function(){return this.svg.append("line").classed("hover-line",!0).style("display","none").attr({x1:0,x2:0,y1:0,y2:this.height})},r.prototype.drawYAxis=function(){return this.yAxis=d3.svg.axis().scale(this.yScale).orient("left").ticks(5).innerTickSize(-this.width).tickFormat(function(t){return function(e){return t.elevationFormatter.formatShort(e)}}(this)),this.svg.append("g").classed("y axis",!0).call(this.yAxis)},r.prototype.drawXAxis=function(){return this.xAxis=d3.svg.axis().scale(this.xScale).orient("bottom").tickFormat(function(t){return function(e){return t.distanceFormatter.formatShort(e)}}(this)),this.svg.append("g").classed("x axis",!0).attr("transform","translate(0, "+this.height+")").call(this.xAxis)},r.prototype.styleTicks=function(){var t;return t=d3.selectAll("g.tick"),t.select("text").classed("axis-tick-text",!0),t.select("line").classed("grid",!0)},r.prototype.drawLine=function(){return this.area=d3.svg.area().x(function(t){return function(e){return t.xScale(e[0])}}(this)).y(function(t){return function(e){return t.yScale(e[1])}}(this)).y0(this.height).interpolate("cardinal").tension(.6),this.drawArea(this.svg.append("path").classed("fill",!0),this.distanceStream,this.elevationStream),this.svg.append("path").classed("highlight",!0).style("display","none").attr("id","chart-highlight")},r.prototype.createHoverTarget=function(){return this.svg.append("rect").classed("hover-target",!0).attr({x:0,y:0,width:this.width,height:this.height}).on("mousemove",this.mousemove()).on("mouseover",function(t){return function(){var e,r;return t.infoBox.style("display",null),t.hoverLine.style("display",null),e=t.xScale.invert(d3.mouse(d3.event.target)[0]),r=d3.bisectLeft(t.distanceStream,e),t.handleMouseOver(r)}}(this)).on("mouseout",function(t){return function(){return t.infoBox.style("display","none"),t.hoverLine.style("display","none"),t.handleMouseOut()}}(this))},r.prototype.handleMouseOver=function(t){return this.rabbit&&this.rabbit.show(),this.eventDispatcher?this.eventDispatcher.dispatchMouseOver(this,"distance",t):void 0},r.prototype.handleMouseOut=function(){return this.rabbit&&this.rabbit.hide(),this.eventDispatcher?this.eventDispatcher.dispatchMouseOut(this,"distance"):void 0},r.prototype.handleMouseMove=function(t){return this.rabbit&&this.rabbit.updatePosition(this.latlngStream[t][0],this.latlngStream[t][1]),this.eventDispatcher?this.eventDispatcher.dispatchMouseOver(this,"distance",t):void 0},r.prototype.mousemove=function(){return function(t){return function(){var e,r,a;return e=t.xScale.invert(d3.mouse(d3.event.target)[0]),a=d3.bisectLeft(t.distanceStream,e),r=t.dataContext.gradeAtIndex(a),t.updateInfoBox(a,t.distanceStream[a],t.elevationStream[a],r),t.hoverLine.attr({x1:t.xScale(t.distanceStream[a]),x2:t.xScale(t.distanceStream[a])}),t.handleMouseMove(a)}}(this)},r.prototype.updateInfoBox=function(t,e,r,a){var i,n,s,o;return i=this.distanceFormatter.formatShort(e),this.infoBox.select("#segment-info-box-distance").text(i),n=this.elevationFormatter.formatShort(r),this.infoBox.select("#segment-info-box-elevation").text(n),s=this.gradeFormatter.formatShort(a),this.infoBox.select("#segment-info-box-grade").text(s),o=this.xScale(this.distanceStream[t])+this.INFO_BOX.MARGIN.SIDE,o+this.INFO_BOX.WIDTH>this.width&&(o=this.xScale(this.distanceStream[t])-this.INFO_BOX.WIDTH-this.INFO_BOX.MARGIN.SIDE),this.infoBox.attr("transform","translate("+o+")")},r.prototype.scopeTo=function(t,e){var r,a,i,n,s,o,h;return h=e-t,o=parseInt(h/3),s=0>=t-o?parseInt(t/3):t-o,n=e+o>this.distanceStream.length-1?parseInt(e+(this.distanceStream.length-1-e)/3):e+o,this.xScale.domain([this.distanceStream[s],this.distanceStream[n]]),a=this.elevationStream.slice(s,n),this.yScale.domain(this.yDomain(a)),this.svg.select(".x.axis").call(this.xAxis),this.svg.select(".y.axis").call(this.yAxis),r=this.svg.select(".fill"),this.drawArea(r,this.distanceStream.slice(s,n),a),i=this.svg.select(".highlight").style("display",null),this.drawArea(i,this.distanceStream.slice(t,e),this.elevationStream.slice(t,e))},r.prototype.drawArea=function(t,e,r){var a,i,n,s,o;for(o=[],n=i=0,s=e.length;s>i;n=++i)a=e[n],o.push([a,r[n]]);return t.datum(o).attr("d",this.area),this.styleTicks()},r.prototype.setOnClick=function(t){return this.svg.select("rect.hover-target").on("click",function(e){return function(){var r,a,i,n;return r=e.xScale.invert(d3.mouse(d3.event.target)[0]),i=d3.bisectLeft(e.distanceStream,r),a=e.dataContext.gradeAtIndex(i),n=e.latlngStream[i],t({distance:r,index:i,grade:a,latlng:n})}}(this))},r}(Backbone.View)}.call(this),function(){Strava.module("Strava.Directory"),Strava.Directory.RabbitManager=function(){function t(t,e,r){this.googleMap=t,this.rabbit=new google.maps.Marker({map:this.googleMap,draggable:!1,clickable:!1,visible:!1,icon:{url:strava.asset.sprite(),size:new google.maps.Size(24,24),origin:e,anchor:r}})}return t.elevationRabbit=function(t){return new Strava.Directory.RabbitManager(t,new google.maps.Point(72,168),new google.maps.Point(12,12))},t.prototype.updatePosition=function(t,e){var r;return r=new google.maps.LatLng(t,e),this.rabbit.setPosition(r)},t.prototype.hide=function(){return this.rabbit.setVisible(!1)},t.prototype.show=function(){return this.rabbit.setVisible(!0)},t}()}.call(this),function(){Strava.module("Strava.Directory"),Strava.Directory.StackedChart=function(){function t(t,e,r,a,i,n){this.timeStream=t,this.stream=e,this.label=r,this.xScale=a,this.color=i,this.formatter=n}return t.prototype.WIDTHS={LABEL:100,CHART:787,HOVER:100},t.prototype.HEIGHT=70,t.prototype.appendTo=function(t){return void 0===this.stream?[void 0,!1]:(this.mainGroup=t.append("g").classed("stacked-chart-container",!0),this.buildMetricGroup(),this.buildChartGroup(),this.buildHoverGroup(),[this.mainGroup,!0])},t.prototype.yScale=function(){var t,e,r,a;return a=d3.extent(this.stream),r=a[0],e=a[1],t=(e-r)/2,d3.scale.linear().range([this.HEIGHT,0]).domain([r-t,e+t])},t.prototype.buildChartGroup=function(){var t,e,r,a,i,n,s,o,h,c;for(c=this.yScale(),o=[],h=this.stream,a=r=0,i=h.length;i>r;a=++r)t=h[a],s=[this.timeStream[a],t],o.push(s);return e=this.mainGroup.append("g").attr("transform","translate("+this.WIDTHS.LABEL+")"),n=d3.svg.line().x(function(t){return function(e){return t.xScale(e[0])}}(this)).y(function(){return function(t){return c(t[1])}}(this)).interpolate("cardinal").tension(.7),e.append("path").classed("metric-chart",!0).style("stroke",this.color).datum(o).attr("d",n),e.append("line").classed("chart-separator",!0).attr({y1:this.HEIGHT-1,y2:this.HEIGHT-1,x1:0,x2:this.WIDTHS.CHART})},t.prototype.buildMetricGroup=function(){var t;return t=this.mainGroup.append("g"),t.append("rect").classed("metric",!0).attr({width:this.WIDTHS.LABEL,height:this.HEIGHT}),t.append("text").classed("metric-label",!0).attr({"text-anchor":"middle",x:this.WIDTHS.LABEL/2,y:this.HEIGHT/2}).text(this.label),t.append("line").classed("box-separator",!0).attr({y1:this.HEIGHT-1,y2:this.HEIGHT-1,x1:0,x2:this.WIDTHS.LABEL})},t.prototype.buildHoverGroup=function(){var t;return t=this.mainGroup.append("g").attr("transform","translate("+(this.WIDTHS.LABEL+this.WIDTHS.CHART)+")"),t.append("rect").classed("metric",!0).attr({width:this.WIDTHS.HOVER,height:this.HEIGHT}),this.value=t.append("text").classed("metric-value",!0).attr({"text-anchor":"middle",x:this.WIDTHS.LABEL/2,y:this.HEIGHT/2}).text("--"),t.append("text").classed("metric-unit",!0).attr({"text-anchor":"middle",x:this.WIDTHS.LABEL/2,y:this.HEIGHT/2+20}).text(this.formatter.unitShort()),t.append("line").classed("box-separator",!0).attr({y1:this.HEIGHT-1,y2:this.HEIGHT-1,x1:0,x2:this.WIDTHS.HOVER})},t.prototype.hover=function(t){return this.value.text(-1===t?"--":this.formatter.format(this.stream[t]))},t}()}.call(this),function(){var t=function(t,r){function a(){this.constructor=t}for(var i in r)e.call(r,i)&&(t[i]=r[i]);return a.prototype=r.prototype,t.prototype=new a,t.__super__=r.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.Directory"),Strava.Directory.TrainerActivityCharts=function(e){function r(){return r.__super__.constructor.apply(this,arguments)}return t(r,e),r.prototype.AXIS_HEIGHT=40,r.prototype.CONTAINER={HEIGHT:4*Strava.Directory.StackedChart.prototype.HEIGHT+r.prototype.AXIS_HEIGHT,WIDTH:Strava.Directory.StackedChart.prototype.WIDTHS.LABEL+Strava.Directory.StackedChart.prototype.WIDTHS.CHART+Strava.Directory.StackedChart.prototype.WIDTHS.HOVER},r.prototype.el="#trainer-charts",r.prototype.initialize=function(t){return this.isRun=t.isRun,this.timeStream=t.streams.time,this.speedStream=t.streams.velocity_smooth,this.powerStream=t.streams.watts,this.heartRateStream=t.streams.heartrate,this.cadenceStream=t.streams.cadence},r.prototype.render=function(){var t,e,r,a,i,n,s,o,h,c,p;for(this.width=this.CONTAINER.WIDTH,this.height=this.CONTAINER.HEIGHT,this.xScale=this.xScale(),this.svg=d3.select("#trainer-charts").append("svg").attr("width",this.CONTAINER.WIDTH).attr("height",this.CONTAINER.HEIGHT).append("g"),this.drawXAxis(),this.styleTicks(),this.isRun?(c=Strava.I18n.Locale.t("strava.charts.activities.chart_context.pace"),h=new Strava.I18n.PaceFormatter):(c=Strava.I18n.Locale.t("strava.charts.activities.chart_context.velocity"),h=new Strava.I18n.DistancePerTimeFormatter,this.speedStream&&(this.speedStream=this.speedStream.map(function(t){return 3600*t}))),e=[new Strava.Directory.StackedChart(this.timeStream,this.speedStream,c,this.xScale,"#21B5EA",h),new Strava.Directory.StackedChart(this.timeStream,this.powerStream,Strava.I18n.Locale.t("strava.charts.activities.chart_context.watts"),this.xScale,"#A75994",new Strava.I18n.PowerFormatter),new Strava.Directory.StackedChart(this.timeStream,this.heartRateStream,Strava.I18n.Locale.t("strava.charts.activities.chart_context.heartrate"),this.xScale,"#B40312",new Strava.I18n.HeartRateFormatter),new Strava.Directory.StackedChart(this.timeStream,this.cadenceStream,Strava.I18n.Locale.t("strava.charts.activities.chart_context.cadence"),this.xScale,"#FE36FE",new Strava.I18n.CadenceFormatter)],s=this.AXIS_HEIGHT,r=0,this.stackedCharts=new Array,i=0,n=e.length;n>i;i++)p=e[i],o=p.appendTo(this.svg),a=o[0],t=o[1],t&&(a.attr("transform","translate(0, "+s+")"),s+=Strava.Directory.StackedChart.prototype.HEIGHT,this.stackedCharts.push(p),r+=1);return this.hoverLine=this.createHoverLine(r),this.createHoverTarget(r)},r.prototype.xScale=function(){return d3.scale.linear().range([0,Strava.Directory.StackedChart.prototype.WIDTHS.CHART]).domain([this.timeStream[0],this.timeStream[this.timeStream.length-1]])},r.prototype.createHoverLine=function(t){return this.svg.append("line").classed("hover-line",!0).style("display","none").attr({x1:0,x2:0,y1:this.AXIS_HEIGHT,y2:t*Strava.Directory.StackedChart.prototype.HEIGHT+this.AXIS_HEIGHT})},r.prototype.drawXAxis=function(){var t,e;return t=new Strava.I18n.TimespanFormatter,e=d3.svg.axis().scale(this.xScale).orient("top").tickFormat(function(e){return t.display(e)}),this.svg.append("g").classed("x axis",!0).attr("transform","translate(100, "+this.AXIS_HEIGHT+")").call(e)},r.prototype.styleTicks=function(){var t;return t=d3.selectAll("g.tick"),t.select("text").classed("axis-tick-text",!0)},r.prototype.createHoverTarget=function(t){return this.svg.append("rect").classed("hover-target",!0).attr({x:Strava.Directory.StackedChart.prototype.WIDTHS.LABEL,y:0,width:Strava.Directory.StackedChart.prototype.WIDTHS.CHART,height:t*Strava.Directory.StackedChart.prototype.HEIGHT}).on("mousemove",this.mousemove()).on("mouseover",function(t){return function(){return t.hoverLine.style("display",null)}}(this)).on("mouseout",function(t){return function(){var e,r,a,i,n;for(t.hoverLine.style("display","none"),i=t.stackedCharts,n=[],r=0,a=i.length;a>r;r++)e=i[r],n.push(e.hover(-1));return n}}(this))},r.prototype.mousemove=function(){return function(t){return function(){var e,r,a,i,n,s,o;for(o=t.xScale.invert(d3.mouse(d3.event.target)[0]-Strava.Directory.StackedChart.prototype.WIDTHS.LABEL),a=d3.bisectLeft(t.timeStream,o),t.hoverLine.attr({x1:t.xScale(t.timeStream[a])+Strava.Directory.StackedChart.prototype.WIDTHS.LABEL,x2:t.xScale(t.timeStream[a])+Strava.Directory.StackedChart.prototype.WIDTHS.LABEL}),n=t.stackedCharts,s=[],r=0,i=n.length;i>r;r++)e=n[r],s.push(e.hover(a));return s}}(this)},r}(Backbone.View)}.call(this);